---
title: "Classification"
author: "Pu Zeng"
date: "11/9/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tree)
library(randomForest)
library(tidyverse)
library(magrittr)
library(reshape)
library(patchwork)
library(ggplot2)
library(gmodels)
library(rpart)
library(e1071)
library(caret)
library(flextable)
```

```{r}
weekly_covid_url_1 = "https://raw.githubusercontent.com/puzeng/BIOSTAT707_Course_Project/main/COVID_Complete/covid_1.csv"
covid_weekly_1 = read_csv(weekly_covid_url_1)


weekly_covid_url_2 = "https://raw.githubusercontent.com/puzeng/BIOSTAT707_Course_Project/main/COVID_Complete/covid_2.csv"
covid_weekly_2 = read_csv(weekly_covid_url_2)

weekly_covid_url_3 = "https://raw.githubusercontent.com/puzeng/BIOSTAT707_Course_Project/main/COVID_Complete/covid_3.csv"
covid_weekly_3 = read_csv(weekly_covid_url_3)

weekly_covid_url_4 = "https://raw.githubusercontent.com/puzeng/BIOSTAT707_Course_Project/main/COVID_Complete/covid_4.csv"
covid_weekly_4 = read_csv(weekly_covid_url_4)

weekly_covid_url_5 = "https://raw.githubusercontent.com/puzeng/BIOSTAT707_Course_Project/main/COVID_Complete/covid_5.csv"
covid_weekly_5 = read_csv(weekly_covid_url_5)

```

```{r}

covid_weekly_1 = covid_weekly_1[, -c(4,5,6,7)]
covid_weekly_2 = covid_weekly_2[, -c(4,5,6,7)]
covid_weekly_3 = covid_weekly_3[, -c(4,5,6,7)]
covid_weekly_4 = covid_weekly_4[, -c(4,5,6,7)]
covid_weekly_5 = covid_weekly_5[, -c(4,5,6,7)]


covid_weekly_1$cluster = if_else(covid_weekly_1$newcases_p > median(covid_weekly_1$newcases_p, na.rm = TRUE), 1, 0)
covid_weekly_2$cluster = if_else(covid_weekly_1$newcases_p > median(covid_weekly_2$newcases_p, na.rm = TRUE), 1, 0)
covid_weekly_3$cluster = if_else(covid_weekly_1$newcases_p > median(covid_weekly_3$newcases_p, na.rm = TRUE), 1, 0)
covid_weekly_4$cluster = if_else(covid_weekly_1$newcases_p > median(covid_weekly_4$newcases_p, na.rm = TRUE), 1, 0)
covid_weekly_5$cluster = if_else(covid_weekly_1$newcases_p > median(covid_weekly_5$newcases_p, na.rm = TRUE), 1, 0)

covid_weekly_1$cluster = as.factor(covid_weekly_1$cluster)
covid_weekly_2$cluster = as.factor(covid_weekly_2$cluster)
covid_weekly_3$cluster = as.factor(covid_weekly_3$cluster)
covid_weekly_4$cluster = as.factor(covid_weekly_4$cluster)
covid_weekly_5$cluster = as.factor(covid_weekly_5$cluster)
```

```{r}
# Decision Tree
# Random Forest
# SVM
covid_weekly_1 %>% group_by(cluster) %>% summarise(n = n())
#### Decision Tree #####

set.seed(2021)

val_sets_1 = createFolds(covid_weekly_1$cluster, k = 5)

error_rate_1 = NULL
acc_rate_1 = NULL

for(i in 1:5){
  test_df = covid_weekly_1[val_sets_1[[i]], ]
  train_df = covid_weekly_1[-val_sets_1[[i]],]
  decision_tree = rpart(cluster ~ ., data = train_df[, 4:ncol(train_df)], control = rpart.control(cp = 0))
  
  prediction = predict(decision_tree, test_df[, 4:18], type = "class")

  acc_rate_1[i] = sum(prediction == test_df$cluster)/length(prediction)
  error_rate_1[i] = sum(prediction != test_df$cluster)/length(prediction)
}

DT_metrics_1 = data.frame(Accuracy = acc_rate_1, Error_Rate = error_rate_1, Fold_num  = 1:5, Set_NO = 1)

val_sets_2 = createFolds(covid_weekly_2$cluster, k = 5)

error_rate_2 = NULL
acc_rate_2 = NULL

for(i in 1:5){
  test_df = covid_weekly_2[val_sets_2[[i]], ]
  train_df = covid_weekly_2[-val_sets_2[[i]],]
  decision_tree = rpart(cluster ~ ., data = train_df[, 4:ncol(train_df)], control = rpart.control(cp = 0))
  
  prediction = predict(decision_tree, test_df[, 4:18], type = "class")

  acc_rate_2[i] = sum(prediction == test_df$cluster)/length(prediction)
  error_rate_2[i] = sum(prediction != test_df$cluster)/length(prediction)
}

DT_metrics_2 = data.frame(Accuracy = acc_rate_2, Error_Rate = error_rate_2, Fold_num  = 1:5, Set_NO = 2)

val_sets_3 = createFolds(covid_weekly_3$cluster, k = 5)

error_rate_3 = NULL
acc_rate_3 = NULL

for(i in 1:5){
  test_df = covid_weekly_3[val_sets_3[[i]], ]
  train_df = covid_weekly_3[-val_sets_3[[i]],]
  decision_tree = rpart(cluster ~ ., data = train_df[, 4:ncol(train_df)], control = rpart.control(cp = 0))
  
  prediction = predict(decision_tree, test_df[, 4:18], type = "class")

  acc_rate_3[i] = sum(prediction == test_df$cluster)/length(prediction)
  error_rate_3[i] = sum(prediction != test_df$cluster)/length(prediction)
}

DT_metrics_3 = data.frame(Accuracy = acc_rate_3, Error_Rate = error_rate_3, Fold_num  = 1:5, Set_NO = 3)

val_sets_4 = createFolds(covid_weekly_4$cluster, k = 5)

error_rate_4 = NULL
acc_rate_4 = NULL

for(i in 1:5){
  test_df = covid_weekly_4[val_sets_4[[i]], ]
  train_df = covid_weekly_4[-val_sets_4[[i]],]
  decision_tree = rpart(cluster ~ ., data = train_df[, 4:ncol(train_df)], control = rpart.control(cp = 0))
  
  prediction = predict(decision_tree, test_df[, 4:18], type = "class")

  acc_rate_4[i] = sum(prediction == test_df$cluster)/length(prediction)
  error_rate_4[i] = sum(prediction != test_df$cluster)/length(prediction)
}

DT_metrics_4 = data.frame(Accuracy = acc_rate_4, Error_Rate = error_rate_4, Fold_num  = 1:5, Set_NO = 4)


val_sets_5 = createFolds(covid_weekly_5$cluster, k = 5)

error_rate_5 = NULL
acc_rate_5 = NULL

for(i in 1:5){
  test_df = covid_weekly_5[val_sets_5[[i]], ]
  train_df = covid_weekly_5[-val_sets_5[[i]],]
  decision_tree = rpart(cluster ~ ., data = train_df[, 4:ncol(train_df)], control = rpart.control(cp = 0))
  
  prediction = predict(decision_tree, test_df[, 4:18], type = "class")

  acc_rate_5[i] = sum(prediction == test_df$cluster)/length(prediction)
  error_rate_5[i] = sum(prediction != test_df$cluster)/length(prediction)
}

DT_metrics_5 = data.frame(Accuracy = acc_rate_5, Error_Rate = error_rate_5, Fold_num  = 1:5, Set_NO = 5)

DT_metrics = rbind.data.frame(DT_metrics_1, DT_metrics_2, DT_metrics_3, DT_metrics_4, DT_metrics_5)

AVE_DT_metrics= DT_metrics %>% group_by(Set_NO) %>% summarise(Ave_Accuracy = mean(Accuracy),
                                              Ave_Error_Rate = mean(Error_Rate))

AVE_DT_metrics$`Ave_Accuracy` = round(AVE_DT_metrics$`Ave_Accuracy`, 4)
AVE_DT_metrics$`Ave_Error_Rate` = round(AVE_DT_metrics$`Ave_Error_Rate`, 4)

colnames(AVE_DT_metrics) = c("covid # data set", "5-folds CV Average Accuracy Rate", "5-folds CV Average Error Rate")

flextable(AVE_DT_metrics)
```


```{r}
control = trainControl(method = "repeatedcv", number = 10, repeats = 3)
tunegrid = expand.grid(.mtry = c(1:10), .ntree = c(60, 80, 100, 120))

customRF = list(type = "Classification", library = "randomForest", loop = NULL)
customRF$parameters = data.frame(parameter = c("mtry", "ntree"),
                                 class = rep("numeric", 2),
                                 label =  c("mtry", "ntree"))

customRF$grid <- function(x, y, len = NULL, search = "grid") {}

customRF$fit <- function(x, y, wts, param, lev, last, weights, classProbs, ...) {
  randomForest(x, y, mtry = param$mtry, ntree=param$ntree, ...)
}

customRF$predict <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
   predict(modelFit, newdata)

customRF$prob <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
   predict(modelFit, newdata, type = "prob")

customRF$sort <- function(x) x[order(x[,1]),]

customRF$levels <- function(x) x$classes

set.seed(2021)

custom = train(cluster~.,
               data = covid_weekly_1[, 4:19],
               method = customRF,
               tuneGrid=tunegrid,
               trControl=control)
```

```{r}
plot(custom)
```

```{r}
control = trainControl(method = "repeatedcv", number = 10, repeats = 3)
tunegrid = expand.grid(.mtry = c(1:10), .ntree = c(60, 80, 100, 120))

customRF = list(type = "Classification", library = "randomForest", loop = NULL)
customRF$parameters = data.frame(parameter = c("mtry", "ntree"),
                                 class = rep("numeric", 2),
                                 label =  c("mtry", "ntree"))

customRF$grid <- function(x, y, len = NULL, search = "grid") {}

customRF$fit <- function(x, y, wts, param, lev, last, weights, classProbs, ...) {
  randomForest(x, y, mtry = param$mtry, ntree=param$ntree, ...)
}

customRF$predict <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
   predict(modelFit, newdata)

customRF$prob <- function(modelFit, newdata, preProc = NULL, submodels = NULL)
   predict(modelFit, newdata, type = "prob")

customRF$sort <- function(x) x[order(x[,1]),]

customRF$levels <- function(x) x$classes

set.seed(2021)

custom = train(cluster~.,
               data = covid_weekly_2[, 4:19],
               method = customRF,
               tuneGrid=tunegrid,
               trControl=control)
```

```{r}
plot(custom)
```

```{r}
custom = train(cluster~.,
               data = covid_weekly_3[, 4:19],
               method = customRF,
               tuneGrid=tunegrid,
               trControl=control)

plot(custom)
```

```{r}
custom = train(cluster~.,
               data = covid_weekly_4[, 4:19],
               method = customRF,
               tuneGrid=tunegrid,
               trControl=control)

plot(custom)
```

```{r}
custom = train(cluster~.,
               data = covid_weekly_5[, 4:19],
               method = customRF,
               tuneGrid=tunegrid,
               trControl=control)

plot(custom)
```


```{r}

rf_1 = randomForest(cluster ~ ., data = covid_weekly_1[, 4:19], ntree = 60, mtry = 4, importance = TRUE)

rf_metrics_1 = data.frame(Error_rate = min(rf_1$err.rate[, 1]), Accuracy = 1-min(rf_1$err.rate[, 1]), Set_NO = 1)

rf_2 = randomForest(cluster ~ ., data = covid_weekly_2[, 4:19], ntree = 100, mtry = 2, importance = TRUE)

rf_metrics_2 = data.frame(Error_rate = min(rf_2$err.rate[, 1]), Accuracy = 1-min(rf_2$err.rate[, 1]), Set_NO = 2)

rf_3 = randomForest(cluster ~ ., data = covid_weekly_3[, 4:19], ntree = 100, mtry = 10, importance = TRUE)

rf_metrics_3 = data.frame(Error_rate = min(rf_3$err.rate[, 1]), Accuracy = 1-min(rf_3$err.rate[, 1]), Set_NO = 3)

rf_4 = randomForest(cluster ~ ., data = covid_weekly_4[, 4:19], ntree = 120, mtry = 9, importance = TRUE)

rf_metrics_4 = data.frame(Error_rate = min(rf_4$err.rate[, 1]), Accuracy = 1-min(rf_4$err.rate[, 1]), Set_NO = 4)

rf_5 = randomForest(cluster ~ ., data = covid_weekly_5[, 4:19], ntree = 120, mtry = 6, importance = TRUE)

rf_metrics_5 = data.frame(Error_rate = min(rf_5$err.rate[, 1]), Accuracy = 1-min(rf_5$err.rate[, 1]), Set_NO = 5)

rf_metrics = rbind.data.frame(rf_metrics_1, rf_metrics_2, rf_metrics_3, rf_metrics_4, rf_metrics_5)

rf_metrics$Error_rate = round(rf_metrics$Error_rate, 4)
rf_metrics$Accuracy = round(rf_metrics$Accuracy, 4)
rf_metrics = rf_metrics[, c(3,2,1)]
colnames(rf_metrics) = c("covid # data set", "OOB Accuracy Rate", "OOB Error Rate")
```


```{r eval=FALSE, include=FALSE}
set.seed(2021)

tune_para_1 = tuneRF(covid_weekly_1[, 4:18], covid_weekly_1$cluster, ntreeTry = 100, improve = 0.05)
tune_para_1 = as.data.frame(tune_para_1)
mtry_num_1 = tune_para_1[which.min(tune_para_1$OOBError),1]

rf_1 = randomForest(cluster ~ ., data = covid_weekly_1[, 4:19], ntree = 100, mtry = mtry_num_1, importance = TRUE)

rf_metrics_1 = data.frame(Error_rate = min(rf_1$err.rate[, 1]), Accuracy = 1-min(rf_1$err.rate[, 1]), Set_NO = 1)

tune_para_2 = tuneRF(covid_weekly_2[, 4:18], covid_weekly_2$cluster, ntreeTry = 100, improve = 0.05)
tune_para_2 = as.data.frame(tune_para_2)
mtry_num_2 = tune_para_2[which.min(tune_para_2$OOBError),1]

rf_2 = randomForest(cluster ~ ., data = covid_weekly_2[, 4:19], ntree = 100, mtry = mtry_num_2, importance = TRUE)

rf_metrics_2 = data.frame(Error_rate = min(rf_2$err.rate[, 1]), Accuracy = 1-min(rf_2$err.rate[, 1]), Set_NO = 2)

tune_para_3 = tuneRF(covid_weekly_3[, 4:18], covid_weekly_3$cluster, ntreeTry = 100, improve = 0.05)
tune_para_3 = as.data.frame(tune_para_3)
mtry_num_3 = tune_para_3[which.min(tune_para_3$OOBError),1]

rf_3 = randomForest(cluster ~ ., data = covid_weekly_3[, 4:19], ntree = 100, mtry = mtry_num_3, importance = TRUE)

rf_metrics_3 = data.frame(Error_rate = min(rf_3$err.rate[, 1]), Accuracy = 1-min(rf_3$err.rate[, 1]), Set_NO = 3)

tune_para_4 = tuneRF(covid_weekly_4[, 4:18], covid_weekly_4$cluster, ntreeTry = 100, improve = 0.05)
tune_para_4 = as.data.frame(tune_para_4)
mtry_num_4 = tune_para_4[which.min(tune_para_4$OOBError),1]

rf_4 = randomForest(cluster ~ ., data = covid_weekly_4[, 4:19], ntree = 100, mtry = mtry_num_4, importance = TRUE)

rf_metrics_4 = data.frame(Error_rate = min(rf_4$err.rate[, 1]), Accuracy = 1-min(rf_4$err.rate[, 1]), Set_NO = 4)



tune_para_5 = tuneRF(covid_weekly_5[, 4:18], covid_weekly_5$cluster, ntreeTry = 100, improve = 0.05)
tune_para_5 = as.data.frame(tune_para_5)
mtry_num_5 = tune_para_5[which.min(tune_para_5$OOBError),1]

rf_5 = randomForest(cluster ~ ., data = covid_weekly_5[, 4:19], ntree = 100, mtry = mtry_num_5, importance = TRUE)

rf_metrics_5 = data.frame(Error_rate = min(rf_5$err.rate[, 1]), Accuracy = 1-min(rf_5$err.rate[, 1]), Set_NO = 5)


rf_metrics = rbind.data.frame(rf_metrics_1, rf_metrics_2, rf_metrics_3, rf_metrics_4, rf_metrics_5)

rf_metrics$Error_rate = round(rf_metrics$Error_rate, 4)
rf_metrics$Accuracy = round(rf_metrics$Accuracy, 4)
rf_metrics = rf_metrics[, c(3,2,1)]
colnames(rf_metrics) = c("covid # data set", "OOB Accuracy Rate", "OOB Error Rate")
```
 
```{r }
DT_metrics %>% group_by(Set_NO) %>% summarise(mean_acc = mean(Accuracy), mean_error = mean(Error_Rate))

DT = DT_metrics %>% 
  summarise(mean_acc = round(mean(Accuracy), 4), mean_error = round(mean(Error_Rate), 4)) %>% 
  mutate(Model = 'Decision Tree')

RF = rf_metrics %>% 
  summarise(mean_acc = round(mean(Accuracy),4), mean_error = round(mean(Error_rate), 4)) %>% 
  mutate(Model = 'Random Forest')

rf_metrics$Error_rate = round(rf_metrics$Error_rate, 4)
rf_metrics$Accuracy = round(rf_metrics$Error_rate, 4)


classification_models = rbind.data.frame(DT, RF)

classification_models
```

```{r}
classification_models_metrics = rf_metrics %>% left_join(AVE_DT_metrics, by = "covid # data set")
classification_models_metrics
ft = flextable(classification_models_metrics)

typology = data.frame(col_keys = colnames(classification_models_metrics),
                      what = c('covid # data set', 
                               'Random Forest', 'Random Forest', 'Decision Tree', 'Decision Tree'),
                      measures = c('covid # data set',"Accuracy", "Error Rate", "Accuracy", "Error Rate"))

ft = set_header_df(ft, mapping = typology, key = 'col_keys')
ft = merge_h(ft, part = 'header')
ft = merge_v(ft, j = 'covid # data set', part = 'header')
ft = theme_vanilla(ft)
ft

colMeans(classification_models_metrics)
```


```{r}
model = glm(cluster ~ ., data = covid_weekly_1[, 4:ncol(covid_weekly_1)], family = 'binomial')
summary(model)
```

